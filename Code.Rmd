```{r echo=FALSE, include=FALSE}
#############################################################################
##             User Modifiable variables
## These variables should be set whenever the underlying data source changes
## or the reporting period changes.
##
## Ideally a new folder should be created for each report
#############################################################################
##
## Change this to reflect newer files. This will be the name of the XL file
FILENM <- "2014-Q3"
##
## The report period start and end dates. This cater for a situation in which
## no sick was taken during the month successeding or preceeding the reporting 
## period. 
## THESE DATES ARE NOT VERIFIED AGAINST TRANSACTION DATES
REPSTRTDT <- as.Date("2014-01-01", format="%Y-%m-%d")
REPENDDT <- as.Date("2014-09-30", format="%Y-%m-%d")

require(ggplot2)
require(zoo)
source ("Code.R")

FileRExt <- paste0(FILENM,".RData")
if (file.exists(FileRExt)) {
    load(FileRExt)
} else {
    FileXLExt <- paste0(FILENM,".xlsx")
    
    if (!file.exists(FileXLExt)) {
        stop(FILENM, " Not Found")
    }
    
    data <- loadData(FileXLExt)
    data <- cleanData(data, FileRExt)
}
```
---
title: "Leave Analysis Report"
author: "Alan C Bonnici"
date: "`r FileProcDt`"
output: html_document
---

## Source Data

The source file is an export to xlsx format from the dakar system. The source data is found on Sheet1 and is made up of the following columns:

* Col A - @ID - Record key  
* Col B - EMPLOYEE_CODE - The Employee's ID card  
* Col C - DEPARTMENT_DESC - Text Description of the Department  
* Col D - ALL_NAME - Employee Name  
* Col E - ALL_DATES - Date when leave was taken  
* Col F - ALL_DAYS_ALPHA - Day of the week  
* Col G - ALL_SHIFT_QTY - _::to be confirmed::_  
* Col H - ALL_SHIFT_DAYS - Days taken _::to be confirmed::_  
* Col I - ABSENCE_CODE - For sick days this is PS

## Data Analysis - Summary

The data file consists of `r nrow(data)` entries spanning `r nrow(dataEmp)` employees. The period covered by the supplied data is from `r format(REPSTRTDT, "%A %d/%m/%Y")` to `r format(REPENDDT, "%A %d/%m/%Y")` *(actual transactions span `r format(min(data$Date), "%A %d/%m/%Y")` to `r format(max(data$Date), "%A %d/%m/%Y")`)*. The total number of sick days covered in this report is `r sum(data$ShiftDays)`.
                 
The list of employees present in the file are `r sort(dataEmp$Name)`. Of these `r length(dataEmp$Name[dataEmp$CurrEmp == TRUE])` employees (*`r dataEmp$Name[dataEmp$CurrEmp == TRUE]`*) are currently employed. 

**Employees who have never taken a day off sick are not in this file and will not appear in the results**.

```{r topLeave}

```

## Departmental Analysis

```{r byYear, echo=FALSE}
g <- ggByYear(data)
g
```

The year(s) with the largest amount of sick days were **`r subset(tmp, cnt == max(cnt), select=dt, drop=TRUE)`**.
The year(s) with the smallest amount of sick days were **`r subset(tmp, cnt == min(cnt), select=dt, drop=TRUE)`**. 

```{r bymonthYr, echo=FALSE}
g <- ggByMonYr(data, REPSTRTDT, REPENDDT)
g
```

The periods(s) with the largest amount of sick days were **`r subset(tmp, cnt == max(cnt), select=dt, drop=TRUE)`**.


```{r byquarterYr, echo=FALSE}
x <- as.yearqtr(data$Date) 
y <- rep(1, length(x))

RepStrtY <- as.numeric(format(REPSTRTDT, "%Y"))
RepStrtQ <- as.numeric(substr(quarters(REPSTRTDT), 2, 2))
RepEndY <- as.numeric(format(REPENDDT, "%Y"))
RepEndQ <- as.numeric(substr(quarters(REPENDDT), 2, 2))

# Pre-Allocate the table
# The table will contain 4 quarters per year.
n <- (RepEndY - RepStrtY + 1) * 4
dt <- character(n)
cnt <- numeric(n)
for (i in RepStrtY:RepEndY) {
    for (j in 1:4) {
        if ((i == RepStrtY) && (j >= RepStrtQ)) {
            if ((i == RepEndY) && (intj <= RepEndQ)) {
                lev <- (i - RepStrtY) * 4 + j
                dt[lev] <- paste0(as.character(i), " Q", as.character(j))
                cnt[lev] <- 0
                }
            }
        }
    }
tmp <- data.frame(dt=as.yearqtr(dt), cnt = cnt, stringsAsFactors = FALSE)

tmp <- rbind(tmp, data.frame(dt = x, cnt = y, stringsAsFactors = FALSE))
tmp <- aggregate(cnt ~ dt, tmp, sum)

g <- ggplot(tmp, (aes(x = as.character(dt), y = cnt)))
g + geom_bar(stat="identity") + ggtitle("Leave taken by Quarter") + xlab("Quarter") +
  ylab("Days") + theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

The quarter(s) with the largest amount of sick days were **`r subset(tmp, cnt == max(cnt), select=dt, drop=TRUE)`**.  
The quarter(s) with the smallest amount of sick days were **`r subset(tmp, cnt == min(cnt), select=dt, drop=TRUE)`**.


```{r byMonth, echo=FALSE}
x <- strftime(data$Date, "%m") 
y <- rep(1, length(x))

RepStrtY <- as.numeric(format(REPSTRTDT, "%Y"))
RepStrtM <- as.numeric(format(REPSTRTDT, "%m"))
RepEndY <- as.numeric(format(REPENDDT, "%Y"))
RepEndM <- as.numeric(format(REPENDDT, "%m"))

# Pre-Allocate the table
n <- 12
dt <- character(n)
cnt <- numeric(n)
for (j in c("01","02","03","04","05","06","07","08","09","10","11","12")) {
    lev <- as.numeric(j)
    # this check is only necessary if incomplete data for one year is provided
    if ((RepStrtY == RepEndY) && (RepStrtM >= lev) && (RepEndM <= lev)) {
        dt[lev] <- j
        cnt[lev] <- 0
        }
    }
tmp <- data.frame(dt[dt != ""], cnt[dt != ""], stringsAsFactors = FALSE)

tmp <- rbind(tmp, data.frame(dt = x, cnt = y))
tmp <- aggregate(cnt ~ dt, tmp, sum)

g <- ggplot(tmp, (aes(x = dt, y = cnt)))
g + geom_bar(stat="identity") + ggtitle("Leave taken by Month") + xlab("Month") +
  ylab("Days")

```

The month(s) with the largest amount of sick days were **`r subset(tmp, cnt == max(cnt), select=dt, drop=TRUE)`**.  
The month(s) with the smallest amount of sick days were **`r subset(tmp, cnt == min(cnt), select=dt, drop=TRUE)`**.

```{r byDOW, echo=FALSE}
g <- ggplot(data, (aes(x = DOW)))
g + geom_bar() + ggtitle("Leave taken by DOW")
```

